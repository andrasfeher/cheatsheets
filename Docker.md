# Docker
From the book "Learning Docker" 2nd Edition by Jeeva S. Chelladhurai, Vinod Singh, Pethuru Raj

## Docker service

__sudo service docker status__: Check the Docker service status

__sudo service docker restart__: Restart the Docker service

__sudo journalctl -u docker__: Extract the Docker log from system journal
  

## Commands for Handling Containers
Format: docker [OPTIONS] COMMAND

__docker pull [thedockerbook/]hello-world[:1.24]__: Download the hello-world image version 1.24 from the "thedockerbook" user at DockerHub; if the version number is omitted, it downloads the latest version

__docker pull registry.example.com/myapp__: Download the myapp image from the registry.example.com third party repository

__docker images [--no-trunc__]__: List the locally available images; --no-trunc: display the full 64 bit ID 

__docker run [--rm] hello-world__: Run the container; --rm: clean up the container as soon as it terminates

__docker search mysql__: Search the mysql image at DockerHub

__docker run -i -t ubuntu:16.04 /bin/bash__: Run the ubuntu:16.04 container interactively with /bin/bash as command; -t: tty connection; -i: interactive; if the image is not found locally, it is downloaded from DockerHub automatically; the bash prompt contains the host id of the container; Ctrl + P and Ctrl + Q escape sequence: detach from the container

__docker attach jolly_lovelace__: Attach to the container 

__docker ps__: List running containers. Port bindings are also displayed 

__docker ps -a__: List all containers irrespective of their status 

__docker diff d5ad60f174d3__: Differences between the container id d5ad60f174d3 and it's image

__docker stop da1c0f7daa2a__: Stop the da1c0f7daa2a container; SIGTERM to the main process, SIGKILL after the grace period  

__docker start [-a] da1c0f7daa2a__: Start the previously stopped container; -a: also attach to the container

__docker restart da1c0f7daa2a__: Restart the container

__docker pause c439077aa80a__: Pause the container

__docker unpause c439077aa80a__: Unpause the container

__docker rm 7473f2568add__: Remove the container

__docker rm $(sudo docker ps -aq)__: Delete all the containers that are not currently running; same as __docker container prune__

__docker commit 472c96295678 learningdocker/ubuntu_wget__: Build an image from a container; can be run on running or stopped container, but it is recommended to run on stopped one

__docker build [-t busyboxplus[:1.0]] .__: Build the image from the Dockerfile in the current directory with the image name busyboxplus and version 1.0 (image name:tagname); the default tagname is "latest"  

__docker run -d ubuntu__: Run container as daemon (detached mode)

__docker logs__: View the output generated by the daemon container

__docker network ls__: List the networks that the Docker Engine created (bridge, host, none) when spins a new container

__docker run --rm --net=none busybox ip addr__: Get the ip address of a container on a specific network 

__docker network inspect bridge__: Get all data about the bridge network

__docker inspect --format='{{.NetworkSettings.IPAddress}}' 4b0b567b6019__: Get the IP address of a container

__docker port \<container id\> 80__: Display the port binding on the Docker host 




## Building and Running Image Examples

Best practices for writing a Dockerfile: https://docs.docker.com/articles/dockerfile_best-practices/

### Apache Container

A Dockerfile:

```
    ###########################################
    # Dockerfile to build an Apache2 image
    ###########################################

    # Base image is Ubuntu
    FROM ubuntu:14.04

    # Author: Dr. Peter
    MAINTAINER Dr. Peter <peterindia@gmail.com>
    
    # Expose port 80
    EXPOSE 80

    # Install apache2 package
    RUN apt-get update &&
    apt-get install -y apache2 &&
    apt-get clean
    
    # Set the log directory PATH
    ENV APACHE_LOG_DIR /var/log/apache2

    # Launch apache2 server in the foreground
    ENTRYPOINT ["/usr/sbin/apache2ctl", "-D", "FOREGROUND"]    
   
```

__docker build -t apache2 .__: Build the image with tag apache2

__docker run -d -p 8080:80 -v /var/log/myhttpd:/var/log/apache2 apache2__: Run the container apache2 as a service i.e. detached mode. Mounting the /var/log/myhttpd
directory of the Docker host to the /var/log/apache2 directory of the container. 8080 host port is translated to 80 container port. Possible port translation formats: \<hostPort\>:\<containerPort\>, \<containerPort\>, \<ip\>:\<hostPort\>:\<containerPort\>, \<ip\>::\<containerPort\>. For port translation the Network Address Translation (NAT) rule in the Linux iptables configuration files are used, which can be checked by running the sudo iptables -t nat -L -n command. -p \<container port\>: auto-generates the Docker host port

__docker logs \<container id\>__: See if the container generates any output on its stdin (standard input) or stderr (standard error)

__docker inspect --format='{{.NetworkSettings.IPAddress}}' \<container id\>__: Get the ip addess of the container. An example of connecting to the container: wget -qO - 172.17.0.13


### Cassandra Cluster

From: https://gokhanatil.com/2018/02/build-a-cassandra-cluster-on-docker.html

```
docker run --name cas1 -p 9042:9042 -e CASSANDRA_CLUSTER_NAME=MyCluster -e CASSANDRA_ENDPOINT_SNITCH=GossipingPropertyFileSnitch -e CASSANDRA_DC=datacenter1 -d cassandra

docker run --name cas2 -e CASSANDRA_SEEDS="$(docker inspect --format='{{ .NetworkSettings.IPAddress }}' cas1)" -e CASSANDRA_CLUSTER_NAME=MyCluster -e CASSANDRA_ENDPOINT_SNITCH=GossipingPropertyFileSnitch -e CASSANDRA_DC=datacenter1 -d cassandra

docker run --name cas3 -e CASSANDRA_SEEDS="$(docker inspect --format='{{ .NetworkSettings.IPAddress }}' cas1)" -e CASSANDRA_CLUSTER_NAME=MyCluster -e CASSANDRA_ENDPOINT_SNITCH=GossipingPropertyFileSnitch -e CASSANDRA_DC=datacenter2 -d cassandra

docker exec -ti cas1 nodetool status
```


## Dockerfile Build Instructions

__FROM ubuntu:16.04__: Sets the base image for the build process

__MAINTAINER Dr. Peter <peterindia@gmail.com>__: Maintainer of the image

__COPY httpd.conf magic /etc/httpd/conf/__: Copy files from the Docker host to the filesystem of the new image; can be multiple sources to single destination; the destination must be a directory and must end with "/"

__ADD web-page-config.tar /__: Similar to copy, but also handles tar files and remote URLs; automatically untars to destination directory

__ENV APACHE_LOG_DIR /var/log/apache__: Sets environment variable; together with ARG can be used in the ADD , COPY , ENV , EXPOSE , LABEL , USER , WORKDIR , VOLUME , STOPSIGNAL , and ONBUILD instructions, see example at ARG

__ARG uid=1000__: Define variables that can be passed during the Docker image build time with the --build-arg flag (e.g. docker build --build-arg usr=app --build-arg uid=100 .); an be used in the ADD , COPY , ENV , EXPOSE ,
LABEL , USER , WORKDIR , VOLUME , STOPSIGNAL , and ONBUILD instructions (e.g. ARG BUILD_VERSION  LABEL com.example.app.build_version=${BUILD_VERSION})

__USER peter__: Start the container with a specific user, instead of the default root; the user must exist in the /etc/passwd file otherwise "finalize namespace setup user get supplementary groups Unable to find user" error at running the container

__WORKDIR /var/log__: Changes the current working directory from / to the path; the path can be absolute or relative

__VOLUME /mnt/src__: Creates a directory in the image filesystem, which can later be used for mounting volumes from the Docker host or the other containers

__EXPOSE 7373[/udp] 8080__: Opens up a container network port for communicating between the container and the external world; the transport protocol is TCP by default; can be multiple ports in a single line e.g. 7373 and 8080

__LABEL version="2.0" release-date="2016-08-05"__: Aadd key-value pairs as metadata; These metadata can be further leveraged to provide meaningful Docker image management and orchestration.

__RUN apt-get update && apt-get install -y apache2__: Run command(s) at build time. The commands are allways executed with /bin/sh -c

__RUN ["bash", "-c", "rm", "-rf", "/tmp/abc"]__: Same as above, but the commands are listed in a JSON array and do not invoke the does not invoke /bin/sh -c

__CMD ["echo", "Dockerfile CMD demo"]__: Similar to RUN, but the command is executed when the container is launched from the newly created image

__ENTRYPOINT ["echo", "Dockerfile ENTRYPOINT demo"]__: Run an application during the complete lifecycle of an image. When the entry point application is terminated, the container is also terminated. It makes the container function as an application. The ENTRYPOINT instruction cannot be overridden by the run subcommand arguments.

__HEALTHCHECK --interval=5m --timeout=3s CMD curl -f http://localhost/ || exit 1__: Monitor the health of the containerized application by running a health monitoring command (or tool) at a prescribed interval. HEALTHCHECK NONE overrides the HEALTHCHECK of the base image.

__ONBUILD ADD config /etc/appconfig__: Registers a build instruction to an image and this gets triggered when another image is built using this image as its base image

__STOPSIGNAL \<signal\>__: Configure an exit signal for your container.  Here, <signal> is either a valid signal name, such as SIGKILL, or a valid unsigned signal number.

__SHELL \<shell\>__: Override the default shell, that is, sh on Linux and cmd on Windows


### The .dockerignore file

The .dockerignore file is a newline-separated TEXT file, wherein you can provide the files and the directories which are to be excluded from the build process. The exclusion list in the file can have both the fully specified file/directory name and the wildcards.

Example:
```
    .git
    *.tmp 
```
  
  
## Running services in a container



 

 



















